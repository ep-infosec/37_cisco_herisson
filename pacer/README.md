# Pacer
## Overview
[SDI interfaces](https://en.wikipedia.org/wiki/Serial_digital_interface), which video production hardware uses, require extremely precise realtime packet timing. For this reason it has been historically difficult to generate SDI compliant streams from general purpose network hardware. (Such as PC, and virtualised hardware)

The pacer overcomes this limitation by using a novel approach: The pacer saturates the Network Interface with dummy packets, in such a way that the NIC's own hardware produces realtime precision timing for the video stream. As such, the pacer paces the herisson stream's packets in such a way that they can be consumed by SDI hardware.

The pacer handles 3 streams:
1. Input stream
    * An unpaced herisson stream to be paced for SDI consumption
2. Output stream
    * The pacer will output the same stream with realtime packet timing
3. Reference Stream:
    * A stream generated by the system which is consuming the output stream, and fed back into the pacer. This stream allows the pacer to synchronize the output stream (see above) with the consumer's timing. The reference stream can be a dummy stream as long as it contains timing information.

```
  Herisson ->1-> Pacer ->2-> SDI ->-┒  
                    └--<--3---<-----┙             
```

Note: A pacer is only required at the outgoing links of a herisson system to an SDI card. Regular herisson links do not require a pacer to pace them.

## Hardware requirements
To achieve realtime precision of high bandwidth streams the pacer requires some dedicated hardware:
* A multi-core CPU
* 2 Dedicated network cards
* The procedures in this document are tested on Ubuntu 16.04

## Building the pacer:
Most of the actions listed below must be run as root

### Configuring DPDK:
The pacer uses the [DPDK](https://dpdk.org) project for direct NIC access. Here are some simplified instructions of what you need to do based on DPDK's [Getting Started Guide](https://doc.dpdk.org/guides/linux_gsg/index.html):

Edit the GRUB configuration files:
* `nano /etc/default/grub`

Change the following line to allow correct memory allocation:  
* `GRUB_CMDLINE_LINUX_DEFAULT="default_hugepagesz=1G hugepagesz=1G hugepages=4"`

Update GRUB configuration:
* `update-grub`
* Now reboot the system for the changes to take effect

Make sure you have checked out the DPDK subproject
* `git submodule update --init --recursive external`


## Building & Installing the Pacer:
1. Install required linux libraries:
  * `apt-get install -y --force-yes python libnuma* linux-headers-$(uname -r) smcroute`

2. Build the pacer using by running [clean_make_pacer.sh](../ip2vf/clean_make_pacer.sh)
3. Install the kernel module:
  * `( cd dpdk/x86_64-native-linuxapp-gcc/kmod && cp igb_uio.ko /lib/modules/$(uname -r)/kernel/drivers/uio/ )`
4. Refresh the modules:
  * `depmod -a`
5. Verify that the module has been installed by searching for it in the list of installed modules
  * `lsmod | grep igb_uio`

### Configure Pacer Deployment:
In this stage we will configure a specific instance of the pacer for runtime:
1. Create a directory to hold the pacer's configuration. ( We will be using ~/pacer in this example, you are free to use any other path )
```
mkdir ~/pacer
cp PATH_TO_HERISSON/pacer/examples/pcap_pacer/* ~/pacer/ 
cd ~/pacer
```
2. Make the binaries accessible to the deployment:
```
ln -s PATH_TO_HERISSON/pacer/examples/pcap_pacer/build/basicfwd vMI_pacer
cp PATH_TO_HERISSON/pacer/examples/pcap_pacer/dpdk-devbind.py .
```
3. Edit [env.sh](../pacer/examples/pcap_pacer/env.sh) to reflect your runtime configuration according to the comments in the file.
  
## Running the Pacer
After configuring the pacer as described above,
you are ready to run the pacer:

`(source env.sh && ./start_pacer)`

### Important messages on stdout:
You can monitor the pacer's output for the following messages, to monitor it's internal status.
* `USER1: Done`
  * Printed after configuration, once an input stream is detected
* `USER1: Resetting state after starvation`
  * The timing is off and the output stream will be reset
  * Printed once when starting output
  * Subsequent prints will result in dropped frames
* `USER1: Frequency in packets per second (cycles): 134778`
 * The number of packets being streamed.
 * This value should not fluctuate by more than +/- 4 packets.
